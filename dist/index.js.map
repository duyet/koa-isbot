{"version":3,"sources":["../src/cache.ts","../src/index.ts"],"names":[],"mappings":";;;;;;AAMO,IAAM,oBAAN,MAAwB;AAAA,EACrB,KAAA;AAAA,EACA,OAAA;AAAA,EACA,GAAA;AAAA,EAER,WAAA,CAAY,OAAA,GAAU,GAAA,EAAM,GAAA,GAAM,IAAA,EAAS;AACzC,IAAA,IAAA,CAAK,KAAA,uBAAY,GAAA,EAAI;AACrB,IAAA,IAAA,CAAK,OAAA,GAAU,OAAA;AACf,IAAA,IAAA,CAAK,GAAA,GAAM,GAAA;AAAA,EACb;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,SAAA,EAA8C;AAChD,IAAA,MAAM,KAAA,GAAQ,IAAA,CAAK,KAAA,CAAM,GAAA,CAAI,SAAS,CAAA;AAEtC,IAAA,IAAI,CAAC,KAAA,EAAO;AACV,MAAA,OAAO,IAAA;AAAA,IACT;AAGA,IAAA,IAAI,KAAK,GAAA,EAAI,GAAI,KAAA,CAAM,SAAA,GAAY,KAAK,GAAA,EAAK;AAC3C,MAAA,IAAA,CAAK,KAAA,CAAM,OAAO,SAAS,CAAA;AAC3B,MAAA,OAAO,IAAA;AAAA,IACT;AAGA,IAAA,IAAA,CAAK,KAAA,CAAM,OAAO,SAAS,CAAA;AAC3B,IAAA,IAAA,CAAK,KAAA,CAAM,GAAA,CAAI,SAAA,EAAW,KAAK,CAAA;AAE/B,IAAA,OAAO,KAAA,CAAM,MAAA;AAAA,EACf;AAAA;AAAA;AAAA;AAAA,EAKA,GAAA,CAAI,WAAmB,MAAA,EAAkC;AAEvD,IAAA,IAAI,IAAA,CAAK,KAAA,CAAM,IAAA,IAAQ,IAAA,CAAK,OAAA,EAAS;AACnC,MAAA,MAAM,WAAW,IAAA,CAAK,KAAA,CAAM,IAAA,EAAK,CAAE,MAAK,CAAE,KAAA;AAC1C,MAAA,IAAI,aAAa,MAAA,EAAW;AAC1B,QAAA,IAAA,CAAK,KAAA,CAAM,OAAO,QAAQ,CAAA;AAAA,MAC5B;AAAA,IACF;AAEA,IAAA,IAAA,CAAK,KAAA,CAAM,IAAI,SAAA,EAAW;AAAA,MACxB,MAAA;AAAA,MACA,SAAA,EAAW,KAAK,GAAA;AAAI,KACrB,CAAA;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,KAAA,GAAc;AACZ,IAAA,IAAA,CAAK,MAAM,KAAA,EAAM;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,IAAA,GAAe;AACjB,IAAA,OAAO,KAAK,KAAA,CAAM,IAAA;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,OAAA,GAAgB;AACd,IAAA,MAAM,GAAA,GAAM,KAAK,GAAA,EAAI;AACrB,IAAA,KAAA,MAAW,CAAC,GAAA,EAAK,KAAK,KAAK,IAAA,CAAK,KAAA,CAAM,SAAQ,EAAG;AAC/C,MAAA,IAAI,GAAA,GAAM,KAAA,CAAM,SAAA,GAAY,IAAA,CAAK,GAAA,EAAK;AACpC,QAAA,IAAA,CAAK,KAAA,CAAM,OAAO,GAAG,CAAA;AAAA,MACvB;AAAA,IACF;AAAA,EACF;AACF,CAAA;;;AC9DA,IAAM,eAAA,GAAoF;AAAA,EACxF,gBAAgB,EAAC;AAAA,EACjB,iBAAiB,EAAC;AAAA,EAClB,QAAA,EAAU,OAAA;AAAA,EACV,KAAA,EAAO,IAAA;AAAA,EACP,SAAA,EAAW,GAAA;AAAA,EACX,QAAA,EAAU,IAAA;AAAA;AAAA,EACV,cAAc,CAAC,GAAA,KAAiB,IAAI,OAAA,CAAQ,OAAA,CAAQ,YAAY,CAAA,IAAK;AACvE,CAAA;AAsCO,SAAS,QAAA,CAAS,OAAA,GAA2B,EAAC,EAAuB;AAE1E,EAAA,MAAM,MAAA,GAAS;AAAA,IACb,GAAG,eAAA;AAAA,IACH,GAAG;AAAA,GACL;AAGA,EAAA,MAAM,KAAA,GAAQ,OAAO,KAAA,GAAQ,IAAI,kBAAkB,MAAA,CAAO,SAAA,EAAW,MAAA,CAAO,QAAQ,CAAA,GAAI,IAAA;AAGxF,EAAA,IAAI,WAAA,GAAc,KAAA;AAClB,EAAA,IAAI,gBAAA,GAAmB,UAAA;AACvB,EAAA,IAAI,kBAAA,GAAqB,YAAA;AAEzB,EAAA,IAAI,OAAO,cAAA,CAAe,MAAA,GAAS,KAAK,MAAA,CAAO,eAAA,CAAgB,SAAS,CAAA,EAAG;AACzE,IAAA,IAAI,QAAA,GAAW,CAAC,GAAG,IAAI,CAAA;AAGvB,IAAA,IAAI,MAAA,CAAO,cAAA,CAAe,MAAA,GAAS,CAAA,EAAG;AACpC,MAAA,MAAM,aAAA,GAAgB,MAAA,CAAO,cAAA,CAAe,GAAA,CAAI,CAAC,MAAO,CAAA,YAAa,MAAA,GAAS,CAAA,CAAE,MAAA,GAAS,CAAE,CAAA;AAC3F,MAAA,QAAA,GAAW,CAAC,GAAG,QAAA,EAAU,GAAG,aAAa,CAAA;AAAA,IAC3C;AAGA,IAAA,IAAI,MAAA,CAAO,eAAA,CAAgB,MAAA,GAAS,CAAA,EAAG;AACrC,MAAA,MAAM,mBAAmB,IAAI,GAAA;AAAA,QAC3B,OAAO,eAAA,CAAgB,OAAA,CAAQ,CAAC,OAAA,KAAY,aAAA,CAAc,OAAO,CAAC;AAAA,OACpE;AACA,MAAA,QAAA,GAAW,QAAA,CAAS,OAAO,CAAC,CAAA,KAAM,CAAC,gBAAA,CAAiB,GAAA,CAAI,CAAC,CAAC,CAAA;AAAA,IAC5D;AAGA,IAAA,MAAM,eAAA,GAAkB,oBAAoB,QAAQ,CAAA;AACpD,IAAA,WAAA,GAAc,CAAC,EAAA,KAAgC,eAAA,CAAgB,EAAA,IAAM,EAAE,CAAA;AAGvE,IAAA,MAAM,gBAAgB,IAAI,MAAA,CAAO,SAAS,IAAA,CAAK,GAAG,GAAG,GAAG,CAAA;AACxD,IAAA,gBAAA,GAAmB,CAAC,EAAA,KAAsC;AACxD,MAAA,IAAI,CAAC,IAAI,OAAO,IAAA;AAChB,MAAA,MAAM,KAAA,GAAQ,EAAA,CAAG,WAAA,EAAY,CAAE,MAAM,aAAa,CAAA;AAClD,MAAA,OAAO,KAAA,GAAQ,CAAC,CAAA,IAAK,IAAA;AAAA,IACvB,CAAA;AACA,IAAA,kBAAA,GAAqB,CAAC,EAAA,KAAiC;AACrD,MAAA,IAAI,CAAC,EAAA,EAAI,OAAO,EAAC;AACjB,MAAA,MAAM,OAAA,GAAU,GAAG,WAAA,EAAY,CAAE,MAAM,IAAI,MAAA,CAAO,aAAA,EAAe,IAAI,CAAC,CAAA;AACtE,MAAA,OAAO,WAAW,EAAC;AAAA,IACrB,CAAA;AAAA,EACF;AAGA,EAAA,IAAI,KAAA,EAAO;AACT,IAAA,MAAM,eAAA,GAAkB,YAAY,MAAM;AACxC,MAAA,KAAA,CAAM,OAAA,EAAQ;AAAA,IAChB,GAAG,GAAM,CAAA;AAGT,IAAA,IAAI,gBAAgB,KAAA,EAAO;AACzB,MAAA,eAAA,CAAgB,KAAA,EAAM;AAAA,IACxB;AAAA,EACF;AAKA,EAAA,MAAM,SAAA,GAAY,CAAC,SAAA,KAA0C;AAE3D,IAAA,MAAM,cAAc,MAAA,CAAO,SAAA,IAAa,EAAE,CAAA,CAAE,KAAA,CAAM,GAAG,IAAI,CAAA;AAEzD,IAAA,MAAM,QAAA,GAAW,YAAY,WAAW,CAAA;AACxC,IAAA,MAAM,OAAA,GAAU,iBAAiB,WAAW,CAAA;AAC5C,IAAA,MAAM,WAAA,GAAc,mBAAmB,WAAW,CAAA;AAElD,IAAA,OAAO;AAAA,MACL,KAAA,EAAO,QAAA;AAAA,MACP,OAAA;AAAA,MACA,WAAA;AAAA,MACA,SAAA,EAAW;AAAA,KACb;AAAA,EACF,CAAA;AAKA,EAAA,OAAO,OAAO,KAAc,IAAA,KAA8B;AAExD,IAAA,MAAM,SAAA,GAAY,MAAA,CAAO,YAAA,CAAa,GAAG,CAAA;AAEzC,IAAA,IAAI,CAAC,SAAA,EAAW;AAEd,MAAC,GAAA,CAAI,KAAA,CAAqC,MAAA,CAAO,QAAQ,CAAA,GAAI;AAAA,QAC3D,KAAA,EAAO,KAAA;AAAA,QACP,OAAA,EAAS,IAAA;AAAA,QACT,aAAa,EAAC;AAAA,QACd,SAAA,EAAW;AAAA,OACb;AACA,MAAA,MAAM,IAAA,EAAK;AACX,MAAA;AAAA,IACF;AAGA,IAAA,IAAI,MAAA,GAAoC,IAAA;AACxC,IAAA,IAAI,KAAA,EAAO;AACT,MAAA,MAAA,GAAS,KAAA,CAAM,IAAI,SAAS,CAAA;AAAA,IAC9B;AAGA,IAAA,IAAI,CAAC,MAAA,EAAQ;AACX,MAAA,MAAA,GAAS,UAAU,SAAS,CAAA;AAG5B,MAAA,IAAI,KAAA,EAAO;AACT,QAAA,KAAA,CAAM,GAAA,CAAI,WAAW,MAAM,CAAA;AAAA,MAC7B;AAAA,IACF;AAGA,IAAC,GAAA,CAAI,KAAA,CAAqC,MAAA,CAAO,QAAQ,CAAA,GAAI,MAAA;AAG7D,IAAA,IAAI,QAAQ,WAAA,EAAa;AACvB,MAAA,MAAM,OAAA,CAAQ,WAAA,CAAY,GAAA,EAAK,MAAM,CAAA;AAAA,IACvC;AAEA,IAAA,IAAI,MAAA,CAAO,KAAA,IAAS,OAAA,CAAQ,aAAA,EAAe;AACzC,MAAA,MAAM,OAAA,CAAQ,aAAA,CAAc,GAAA,EAAK,MAAM,CAAA;AAAA,IACzC;AAEA,IAAA,MAAM,IAAA,EAAK;AAAA,EACb,CAAA;AACF;AAKA,IAAO,aAAA,GAAQ","file":"index.js","sourcesContent":["import type { BotDetectionResult, CacheEntry } from './types.js';\n\n/**\n * Simple LRU cache with TTL support\n * Optimized for bot detection results\n */\nexport class BotDetectionCache {\n  private cache: Map<string, CacheEntry>;\n  private maxSize: number;\n  private ttl: number;\n\n  constructor(maxSize = 1000, ttl = 3600000) {\n    this.cache = new Map();\n    this.maxSize = maxSize;\n    this.ttl = ttl;\n  }\n\n  /**\n   * Get a cached result if available and not expired\n   */\n  get(userAgent: string): BotDetectionResult | null {\n    const entry = this.cache.get(userAgent);\n\n    if (!entry) {\n      return null;\n    }\n\n    // Check if expired\n    if (Date.now() - entry.timestamp > this.ttl) {\n      this.cache.delete(userAgent);\n      return null;\n    }\n\n    // Move to end (LRU)\n    this.cache.delete(userAgent);\n    this.cache.set(userAgent, entry);\n\n    return entry.result;\n  }\n\n  /**\n   * Store a detection result in cache\n   */\n  set(userAgent: string, result: BotDetectionResult): void {\n    // Evict oldest entry if cache is full\n    if (this.cache.size >= this.maxSize) {\n      const firstKey = this.cache.keys().next().value;\n      if (firstKey !== undefined) {\n        this.cache.delete(firstKey);\n      }\n    }\n\n    this.cache.set(userAgent, {\n      result,\n      timestamp: Date.now(),\n    });\n  }\n\n  /**\n   * Clear all cached entries\n   */\n  clear(): void {\n    this.cache.clear();\n  }\n\n  /**\n   * Get current cache size\n   */\n  get size(): number {\n    return this.cache.size;\n  }\n\n  /**\n   * Clean up expired entries\n   */\n  cleanup(): void {\n    const now = Date.now();\n    for (const [key, entry] of this.cache.entries()) {\n      if (now - entry.timestamp > this.ttl) {\n        this.cache.delete(key);\n      }\n    }\n  }\n}\n","import { isbot, isbotMatch, isbotMatches, createIsbotFromList, isbotPatterns, list } from 'isbot';\nimport type { Context, Next } from 'koa';\nimport { BotDetectionCache } from './cache.js';\nimport type {\n  BotDetectionResult,\n  KoaIsBotMiddleware,\n  KoaIsBotOptions,\n  KoaContextWithBot,\n} from './types.js';\n\n// Export types for consumers\nexport type {\n  BotDetectionResult,\n  KoaIsBotOptions,\n  KoaContextWithBot,\n  KoaIsBotMiddleware,\n} from './types.js';\n\n/**\n * Default options for the middleware\n */\nconst DEFAULT_OPTIONS: Required<Omit<KoaIsBotOptions, 'onBotDetected' | 'onDetection'>> = {\n  customPatterns: [],\n  excludePatterns: [],\n  stateKey: 'isBot',\n  cache: true,\n  cacheSize: 1000,\n  cacheTTL: 3600000, // 1 hour\n  getUserAgent: (ctx: Context) => ctx.request.headers['user-agent'] || '',\n};\n\n/**\n * Creates a Koa middleware for bot detection using the isbot library\n *\n * @param options - Configuration options for the middleware\n * @returns Koa middleware function\n *\n * @example\n * Basic usage:\n * ```typescript\n * import Koa from 'koa';\n * import { koaIsBot } from '@duyetdev/koa-isbot';\n *\n * const app = new Koa();\n * app.use(koaIsBot());\n *\n * app.use((ctx) => {\n *   if (ctx.state.isBot?.isBot) {\n *     console.log(`Bot detected: ${ctx.state.isBot.botName}`);\n *   }\n * });\n * ```\n *\n * @example\n * With custom configuration:\n * ```typescript\n * app.use(koaIsBot({\n *   customPatterns: ['mybot', /customcrawler/i],\n *   excludePatterns: ['chrome-lighthouse'],\n *   stateKey: 'bot',\n *   cache: true,\n *   onBotDetected: (ctx, result) => {\n *     console.log('Bot visit:', result.botName);\n *   }\n * }));\n * ```\n */\nexport function koaIsBot(options: KoaIsBotOptions = {}): KoaIsBotMiddleware {\n  // Merge with default options\n  const config = {\n    ...DEFAULT_OPTIONS,\n    ...options,\n  };\n\n  // Initialize cache if enabled\n  const cache = config.cache ? new BotDetectionCache(config.cacheSize, config.cacheTTL) : null;\n\n  // Create custom isbot detector if needed\n  let customIsBot = isbot;\n  let customIsbotMatch = isbotMatch;\n  let customIsbotMatches = isbotMatches;\n\n  if (config.customPatterns.length > 0 || config.excludePatterns.length > 0) {\n    let patterns = [...list];\n\n    // Add custom patterns\n    if (config.customPatterns.length > 0) {\n      const customStrings = config.customPatterns.map((p) => (p instanceof RegExp ? p.source : p));\n      patterns = [...patterns, ...customStrings];\n    }\n\n    // Remove excluded patterns\n    if (config.excludePatterns.length > 0) {\n      const patternsToRemove = new Set(\n        config.excludePatterns.flatMap((pattern) => isbotPatterns(pattern))\n      );\n      patterns = patterns.filter((p) => !patternsToRemove.has(p));\n    }\n\n    // Create custom detector\n    const baseCustomIsBot = createIsbotFromList(patterns);\n    customIsBot = (ua?: string | null): boolean => baseCustomIsBot(ua || '');\n\n    // Create custom match functions\n    const customPattern = new RegExp(patterns.join('|'), 'i');\n    customIsbotMatch = (ua?: string | null): string | null => {\n      if (!ua) return null;\n      const match = ua.toLowerCase().match(customPattern);\n      return match?.[0] ?? null;\n    };\n    customIsbotMatches = (ua?: string | null): string[] => {\n      if (!ua) return [];\n      const matches = ua.toLowerCase().match(new RegExp(customPattern, 'gi'));\n      return matches ?? [];\n    };\n  }\n\n  // Periodic cache cleanup (every 10 minutes)\n  if (cache) {\n    const cleanupInterval = setInterval(() => {\n      cache.cleanup();\n    }, 600000);\n\n    // Don't keep the process alive for this interval\n    if (cleanupInterval.unref) {\n      cleanupInterval.unref();\n    }\n  }\n\n  /**\n   * Detect bot from user agent string\n   */\n  const detectBot = (userAgent: string): BotDetectionResult => {\n    // Security: Validate and sanitize input\n    const sanitizedUA = String(userAgent || '').slice(0, 2048); // Limit length to prevent DoS\n\n    const detected = customIsBot(sanitizedUA);\n    const botName = customIsbotMatch(sanitizedUA);\n    const botPatterns = customIsbotMatches(sanitizedUA);\n\n    return {\n      isBot: detected,\n      botName,\n      botPatterns,\n      userAgent: sanitizedUA,\n    };\n  };\n\n  /**\n   * The middleware function\n   */\n  return async (ctx: Context, next: Next): Promise<void> => {\n    // Extract user agent\n    const userAgent = config.getUserAgent(ctx);\n\n    if (!userAgent) {\n      // No user agent, assume not a bot\n      (ctx.state as KoaContextWithBot['state'])[config.stateKey] = {\n        isBot: false,\n        botName: null,\n        botPatterns: [],\n        userAgent: '',\n      };\n      await next();\n      return;\n    }\n\n    // Check cache first\n    let result: BotDetectionResult | null = null;\n    if (cache) {\n      result = cache.get(userAgent);\n    }\n\n    // Detect if not in cache\n    if (!result) {\n      result = detectBot(userAgent);\n\n      // Store in cache\n      if (cache) {\n        cache.set(userAgent, result);\n      }\n    }\n\n    // Store result in context state\n    (ctx.state as KoaContextWithBot['state'])[config.stateKey] = result;\n\n    // Call callbacks if provided\n    if (options.onDetection) {\n      await options.onDetection(ctx, result);\n    }\n\n    if (result.isBot && options.onBotDetected) {\n      await options.onBotDetected(ctx, result);\n    }\n\n    await next();\n  };\n}\n\n/**\n * Default export for convenience\n */\nexport default koaIsBot;\n\n/**\n * Re-export useful isbot functions for advanced usage\n */\nexport { isbot, isbotMatch, isbotMatches, createIsbotFromList, list as isbotPatternList };\n"]}